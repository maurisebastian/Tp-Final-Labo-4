<div class="review-section">

 
  <!-- ‚≠ê SI YA RESE√ë√ì, NO MOSTRAR FORMULARIO -->
  @if (userAlreadyReviewed) {
    <div class="already-reviewed-box">
      <h3>Ya dejaste una rese√±a para esta pel√≠cula</h3>

      <p><strong>Tu calificaci√≥n:</strong> {{ existingReview?.score }} / 10</p>

      <p class="review-description">{{ existingReview?.description }}</p>

      <p class="info">Solo puedes dejar una rese√±a por pel√≠cula.</p>
    </div>
  }
  @else {
    <!-- ‚≠ê FORMULARIO ORIGINAL -->
    <div class="add-review">
      <h3 class="section-title">Agrega tu rese√±a</h3>

      <form [formGroup]="reviewForm" (submit)="addReview($event)">
        <div class="star-rating mb-3">
          @for (star of [1,2,3,4,5,6,7,8,9,10]; track $index) {
            <span (click)="setStarRating(star)"
                  class="star"
                  [class.selected]="star <= +reviewForm.controls.score.value">
              ‚òÖ
            </span>
          }
          <span class="rating-label">
            Calificaci√≥n: {{ reviewForm.get('score')?.value || 0 }} / 10
          </span>
        </div>

        <textarea formControlName="description"
                  class="review-textarea"
                  placeholder="Escribe tu rese√±a aqu√≠..."></textarea>

        <button type="submit" class="btn-primary" [disabled]="reviewForm.invalid">
          Agregar rese√±a
        </button>
      </form>
    </div>
  }

  <!-- LISTADO -->
  <div class="reviews-list-block">

    <h3 class="section-title">Rese√±as</h3>

    @if (reviews.length === 0) {
      <span class="empty-reviews">No hay rese√±as disponibles para esta pel√≠cula.</span>
    }

    @for (review of reviews; track review.id) {

      <div class="card-rese√±as">
        <div class="review-info">

          <strong>
            Usuario:
            <button type="button" class="user-link"
                    (click)="goToUserProfile(review.idProfile)">
              {{ review.userName || ('Usuario #' + review.idProfile) }}
            </button>
          </strong>

          <span class="review-score">
            <strong>Calificaci√≥n:</strong> {{ review.score }} / 10
          </span>

        </div>

        <button class="btn-like" (click)="toggleLike(review)">
          @if (review.likedByUser) { ‚ù§Ô∏è {{ review.likesCount }} }
          @else { ü§ç {{ review.likesCount }} }
        </button>

        <button class="btn-report" (click)="reportReview(review)">üö© Reportar rese√±a</button>

        @if (review.idProfile === userId || isAdmin) {
          <button class="btn-delete" (click)="deleteReview(review.id)">Eliminar</button>
        }
      </div>

      <p class="review-description">{{ review.description }}</p>

      <!-- COMENTARIOS -->
      <div class="comments-block">

        @if (review.comments?.length === 0) {
          <p class="no-comments">No hay comentarios a√∫n.</p>
        }

        @for (comment of review.comments; track comment.id) {
          <div class="comment-item">
            <strong>
              <button type="button" class="user-link"
                      (click)="goToUserProfile(comment.idProfile)">
                {{ comment.userName || ('Usuario #' + comment.idProfile) }}
              </button>:
            </strong>

            <span>{{ comment.comment }}</span>

            <button type="button" class="btn-report-comment"
                    (click)="reportComment(review, comment)">üö©</button>
          </div>
        }

        @if (userLoggedIn) {
          <form (submit)="addComment($event, review)">
            <input type="text"
                   [formControl]="getControl(review.id!)"
                   class="form-control"
                   placeholder="Escribe un comentario...">
            <button type="submit">Comentar</button>
          </form>
        }

      </div>
    }
  </div>

</div>
